/*
 * GSM.c
 *
 *  Created on: 10.04.2017
 *      Author: Krzysztof
 */
#include "stm32f7xx_hal.h"
#include "rtc.h"
#include "usart.h"
#include <stdlib.h>
#include "string.h"
#include "GSM.h"

unsigned char g_GSM_ReceivedData[20];
volatile uint8_t g_GSM_ATReadyFlag=0;
volatile uint8_t g_GSM_BaudrateSetFlag=0;

void HAL_UART_RxCpltCallback(UART_HandleTypeDef* huart)
{
	if(huart==&GSM_huart)
	{
		if(!g_GSM_ATReadyFlag)
			GSM_VerifyATReady();
		else if(!g_GSM_BaudrateSetFlag)
			GSM_VerifyAutoBaudrate();
	}
}

void HAL_UART_TxCpltCallback(UART_HandleTypeDef* huart)
{
	if(huart==&GSM_huart)
		if(!g_GSM_BaudrateSetFlag)
			HAL_UART_Receive_IT(&GSM_huart,g_GSM_ReceivedData,GSM_AUTOBAUDRATE_MESSAGE_SIZE);
}

void RetransmitEcho(UART_HandleTypeDef* huart,uint16_t p_MessageSize)
{
	unsigned char EchoData[p_MessageSize];
	HAL_UART_Transmit_IT(huart,EchoData,p_MessageSize);
	HAL_UART_Receive_IT(huart,EchoData,p_MessageSize);
}

void GSM_WaitForATReady()
{
	HAL_GPIO_WritePin(GSM_PWRKEY_GPIO_Port,GSM_PWRKEY_Pin,GPIO_PIN_SET);
	HAL_UART_Receive_IT(&GSM_huart,g_GSM_ReceivedData,GSM_ATREADY_MESSAGE_SIZE);
}

void GSM_VerifyATReady()
{
	if(strncmp(g_GSM_ReceivedData,GSM_ATREADY_MESSAGE,GSM_ATREADY_MESSAGE_SIZE)==0)
		g_GSM_ATReadyFlag=1;
	else
	{
		g_GSM_ATReadyFlag=0;
		HAL_GPIO_WritePin(GSM_PWRKEY_GPIO_Port,GSM_PWRKEY_Pin,GPIO_PIN_RESET);
		HAL_GPIO_WritePin(GSM_PWRKEY_GPIO_Port,GSM_PWRKEY_Pin,GPIO_PIN_SET);
		HAL_UART_Receive_IT(&GSM_huart,g_GSM_ReceivedData,GSM_ATREADY_MESSAGE_SIZE);
	}
}

uint8_t GSM_isATReady()
{
	if(g_GSM_ATReadyFlag)
		return 1;
	else
		return 0;
}

void GSM_AutoBaudrate_Synchronize()
{
	if(!g_GSM_ATReadyFlag)
	{
		HAL_UART_Transmit_IT(&GSM_huart,"AT\r\n",GSM_AUTOBAUDRATE_MESSAGE_SIZE);
	}
}

void GSM_VerifyAutoBaudrate()
{
	if(strncmp(g_GSM_ReceivedData,"OK\r\n",GSM_RETURN_MESSAGE_SIZE-2)==0)
		g_GSM_BaudrateSetFlag=1;
	else
	{
		g_GSM_BaudrateSetFlag=0;
		HAL_UART_Transmit_IT(&GSM_huart,"AT\r\n",GSM_AUTOBAUDRATE_MESSAGE_SIZE);
	}
}

uint8_t GSM_isBaudrateSet()
{
	if(g_GSM_BaudrateSetFlag)
		return 1;
	else
		return 0;
}
